<header class="bg-gray-top sticky top-0 z-10 flex flex-col justify-center items-stretch gap-2 p-12-16">
  <div class="flex items-center p-0">
    <button class="inline-flex items-center justify-center border-0 bg-transparent cursor-pointer text-base transition-all duration-33 user-select-none align-middle min-h-12 px-3 py-2 text-white hidden" aria-label="Go back">
      <span aria-hidden="true" class="flex">
        <svg data-encore-id="icon" role="img" aria-hidden="true" viewBox="0 0 24 24" class="fill-current w-6 h-6">
          <path d="M13.414 3.5a.999.999 0 0 0-1.707-.707l-9.207 9.2 9.207 9.202a1 1 0 1 0 1.414-1.413L6.335 13H20.5a1 1 0 0 0 0-2H6.322l6.799-6.794a.999.999 0 0 0 .293-.707z"></path>
        </svg>
      </span>
    </button>
    <div class="relative flex w-full">
      <svg data-encore-id="icon" role="img" aria-hidden="true" class="absolute top-1/2 left-3 text-black transform -translate-y-1/2 w-4 h-4 fill-current" viewBox="0 0 16 16">
        <path d="M7 1.75a5.25 5.25 0 1 0 0 10.5 5.25 5.25 0 0 0 0-10.5zM.25 7a6.75 6.75 0 1 1 12.096 4.12l3.184 3.185a.75.75 0 1 1-1.06 1.06L11.304 12.2A6.75 6.75 0 0 1 .25 7z"></path>
      </svg>
      <input 
        placeholder="Bạn muốn hát bài nào?" 
        class="bg-white border-none rounded-md text-black px-10 py-2 w-full text-base leading-normal font-bold" 
        data-testid="search-input" 
        id="search"
        autocomplete="off"
        value="" 
        onkeydown="if(event.key === 'Enter') { 
          event.preventDefault();
          const query = $('#search').val().trim();
          if (query) {
            searchVideos();
          } else {
            alert('Vui lòng nhập tên bài hát');
          }
        }">
    </div>
  </div>
  <div class="relative">
    <div class="overflow-x-scroll whitespace-nowrap scrollbar-none py-2" data-testid="filter-chips-container">
      <button class="box-border tap-highlight-transparent bg-transparent border-0 text-inherit cursor-pointer leading-1 tracking-inherit p-0 rounded-md inline-flex align-middle max-w-full mr-2 overflow-clip relative flex-shrink-0 marginal font-normal" role="checkbox" aria-checked="false" data-encore-id="chip"><span class="box-border tap-highlight-transparent rounded-md text-white transition-all duration-200 inline-flex min-w-0 min-h-8 items-center py-1 px-3 bg-black/12 font-bold">Tất cả</span></button>
      <button class="box-border tap-highlight-transparent bg-transparent border-0 text-inherit cursor-pointer leading-1 tracking-inherit p-0 rounded-md inline-flex align-middle max-w-full mr-2 overflow-clip relative flex-shrink-0 marginal font-normal" role="checkbox" aria-checked="false" data-encore-id="chip"><span class="box-border tap-highlight-transparent rounded-md text-white transition-all duration-200 inline-flex min-w-0 min-h-8 items-center py-1 px-3 bg-black/12 font-bold">Karaoke</span></button>
    </div>
  </div>
</header>
<script>
    $(document).ready(function() {
        $('#search').on('input', function() {
            $('.clear-button').remove(); // Xóa nút clear trước đó

            // Kiểm tra nếu ô tìm kiếm không rỗng
            if ($(this).val().trim() !== '') {
                const clearButton = `
                    <button class="box-border tap-highlight-transparent bg-transparent border-0 rounded-full cursor-pointer absolute text-center no-underline text-normal touch-manipulation transition-duration-33 transition-all user-select-none vertical-align-middle  color-subdued min-inline-size-0 inline-flex items-center justify-center right-3 color-black top-1-2 -translate-y-1-2 overflow-wrap-anywhere clear-button" style="-webkit-transform: translateY(-50%);transform: translateY(-50%);"
                            data-testid="search-input-clear-button" 
                            aria-label="Clear search field" 
                            data-encore-id="buttonTertiary">
                        <span aria-hidden="true" class="flex">
                            <svg data-encore-id="icon" role="img" aria-hidden="true" viewBox="0 0 16 16" class="w-4 h-4 fill-current">
                                <path d="M2.47 2.47a.75.75 0 0 1 1.06 0L8 6.94l4.47-4.47a.75.75 0 1 1 1.06 1.06L9.06 8l4.47 4.47a.75.75 0 1 1-1.06 1.06L8 9.06l-4.47 4.47a.75.75 0 0 1-1.06-1.06L6.94 8 2.47 3.53a.75.75 0 0 1 0-1.06Z"></path>
                            </svg>
                        </span>
                    </button>
                `;
                $(this).after(clearButton); // Thêm nút clear sau ô tìm kiếm
            }
        });

        // Xóa nội dung ô tìm kiếm và nút clear khi nhấn nút clear
        $(document).on('click', '.clear-button', function() {
            $('#search').val(''); // Xóa giá trị ô tìm kiếm
            $(this).remove(); // Xóa nút clear
        });
    });
</script>
<script>
  $(document).ready(function() {
    const $search = $('#search');
    const $clearSearch = $('#clearSearch');

    $search.on('input', function() {
      $clearSearch.toggle($(this).val().length > 0);
    });

    $clearSearch.on('click', function() {
      $search.val('').trigger('input');
    });
  });

  const supabaseClient = supabase.createClient('https://wndajplczagmlxbvkmtk.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduZGFqcGxjemFnbWx4YnZrbXRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwMTUzNDcsImV4cCI6MjA0MzU5MTM0N30.1ffeOEC-jOQtar3tgD8OPBUeyK79itCPYmBe3_k08MA');

  function searchVideos() {
      const query = $('#search').val();
      const apiKey = 'AIzaSyDXo9tP0rycwrE4tpXokP1AggTRP7Zt2B4';
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=24&q=${query}&type=video&key=${apiKey}`;
  
      $.getJSON(url, function(data) {
          $('#videoList').empty();
          const wrapper = $('<div id="list" class="w-full h-full"></div>');
          $('#videoList').append(wrapper);
          if (!data.items.length) {
              return alert('Không tìm thấy video nào.');
          }
  
          const videoIds = data.items.map(item => item.id.videoId).join(',');
          const videoDetailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id=${videoIds}&key=${apiKey}`;
  
          $.getJSON(videoDetailsUrl, function(videoDetailsData) {
              data.items.forEach((item, index) => {
                  const { videoId } = item.id;
                  const title = item.snippet.title;
                  const channelTitle = item.snippet.channelTitle;
                  const thumbnailUrl = item.snippet.thumbnails.maxres?.url || item.snippet.thumbnails.high?.url || item.snippet.thumbnails.default.url;
                  const channelThumbnailUrl = item.snippet.thumbnails.default.url;
                  const publishedAt = item.snippet.publishedAt;
                  const viewCount = videoDetailsData.items[index].statistics.viewCount;
                  const duration = formatDuration(videoDetailsData.items[index].contentDetails.duration);
  
                  const videoItem = $(`
                      <div class="cursor-pointer flex w-full flex-col mb-6" onclick="handleSongSelection('${videoId}', '${title}')">
                          <div class="relative video-thumbnail-container-large center block m-0 p-0">
                              <div class="cover video-thumbnail-img video-thumbnail-bg"></div>
                              <img src="${thumbnailUrl}" class="w-full h-full cover object-cover" />
                              <div class="absolute bottom-0 right-0 m-2">
                                  <div class="badge">${duration}</div>
                              </div>
                          </div>
                          <div class="media-item-info cbox">
                            <div class="media-item-metadata">
                              <div class="flex items-center" style="margin: 4px 0 16px 12px;">
                                <icon class="channel-thumbnail-icon YtProfileIconHost" aria-hidden="false">
                                  <img alt="Truy cập kênh" class="YtProfileIconImage" src="${channelThumbnailUrl}">
                                </icon>
                                <div class="ml-3 text-left">
                                  <h3 class="mb-1"><span class="text-white font-bold line-clamp-2 leading-5">${title}</span></h3>
                                  <span class="text-gray-400 text-xs" style="color:#b3b3b3">${channelTitle} • ${formatViews(viewCount)} • ${formatDate(publishedAt)}</span>
                                </div>
                              </div>
                            </div>
                            <menu-renderer class="media-item-menu">
                              <menu>
                                <button class="icon-button" aria-label="Menu tác vụ" aria-haspopup="true">
                                  <c3-icon style="">
                                    <span class="yt-icon-shape yt-spec-icon-shape">
                                      <div style="width: 100%; height: 100%; display: block; fill: currentcolor;">
                                        <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24" focusable="false" aria-hidden="true" style="pointer-events: none; display: inherit; width: 100%; height: 100%;">
                                          <path d="M12 16.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zM10.5 12c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5-1.5.67-1.5 1.5zm0-6c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5-.67-1.5-1.5-1.5-1.5.67-1.5 1.5z"></path>
                                        </svg>
                                      </div>
                                    </span>
                                  </c3-icon>
                                </button>
                              </menu>
                            </menu-renderer>
                          </div>
                      </div>
                  `);
                $('#list').append(videoItem);
              });
          });
      });
  }

  function handleSongSelection(videoId, title) {
    const name = prompt("Nhập tên của bạn:");
    if (name) {
      saveSong(videoId, title, name).then(() => {
        window.location.href = '/songs';
      }).catch(() => {
        alert("Đã xảy ra lỗi khi lưu thông tin. Vui lòng thử lại.");
      });
    }
  }

  function saveSong(videoId, songName, name) {
    return supabaseClient.from('karaoke_songs').insert([{ video_id: videoId, song_name: songName, name: name }]);
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    const secondsInMinute = 60;
    const secondsInHour = secondsInMinute * 60;
    const secondsInDay = secondsInHour * 24;
    const secondsInWeek = secondsInDay * 7;
    const secondsInYear = secondsInDay * 365;
  
    if (diffInSeconds < secondsInMinute) {
      return 'Vừa xong';
    } else if (diffInSeconds < secondsInHour) {
      const minutes = Math.floor(diffInSeconds / secondsInMinute);
      return `${minutes} phút trước`;
    } else if (diffInSeconds < secondsInDay) {
      const hours = Math.floor(diffInSeconds / secondsInHour);
      return `${hours} giờ trước`;
    } else if (diffInSeconds < secondsInWeek) {
      const days = Math.floor(diffInSeconds / secondsInDay);
      return `${days} ngày trước`;
    } else if (diffInSeconds < secondsInYear) {
      const weeks = Math.floor(diffInSeconds / secondsInWeek);
      return `${weeks} tuần trước`;
    } else {
      const years = Math.floor(diffInSeconds / secondsInYear);
      return `${years} năm trước`;
    }
  }

  function formatViews(views) {
    return views > 1000000 ? (views / 1000000).toFixed(1) + ' Tr lượt xem' : views > 1000 ? (views / 1000).toFixed(1) + ' N lượt xem' : views + ' lượt xem';
  }

  function formatDuration(duration) {
    const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
    const hours = match[1] ? match[1].slice(0, -1) : '0';
    const minutes = match[2] ? match[2].slice(0, -1) : '0';
    const seconds = match[3] ? match[3].slice(0, -1) : '0';
  
    if (hours === '0') {
      return `${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}`;
    } else {
      return `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}`;
    }
  }
</script>
