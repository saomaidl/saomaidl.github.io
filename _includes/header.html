<header class="bg-gray-top sticky top-0 z-10 flex flex-col justify-center items-stretch gap-2 p-12-16">
  <div class="flex items-center p-0">
    <button class="inline-flex items-center justify-center border-0 bg-transparent cursor-pointer text-base transition-all duration-33 user-select-none align-middle min-h-12 px-3 py-2 text-white hidden" aria-label="Go back">
      <span aria-hidden="true" class="flex">
        <svg data-encore-id="icon" role="img" aria-hidden="true" viewBox="0 0 24 24" class="fill-current w-6 h-6">
          <path d="M13.414 3.5a.999.999 0 0 0-1.707-.707l-9.207 9.2 9.207 9.202a1 1 0 1 0 1.414-1.413L6.335 13H20.5a1 1 0 0 0 0-2H6.322l6.799-6.794a.999.999 0 0 0 .293-.707z"></path>
        </svg>
      </span>
    </button>
    <div class="relative flex w-full">
      <svg data-encore-id="icon" role="img" aria-hidden="true" class="absolute top-1/2 left-3 text-black transform -translate-y-1/2 w-4 h-4 fill-current" viewBox="0 0 16 16">
        <path d="M7 1.75a5.25 5.25 0 1 0 0 10.5 5.25 5.25 0 0 0 0-10.5zM.25 7a6.75 6.75 0 1 1 12.096 4.12l3.184 3.185a.75.75 0 1 1-1.06 1.06L11.304 12.2A6.75 6.75 0 0 1 .25 7z"></path>
      </svg>
      <input 
        placeholder="Bạn muốn hát bài nào?" 
        class="bg-white border-none rounded-md text-black px-10 py-2 w-full text-base leading-normal font-bold" 
        data-testid="search-input" 
        value="" 
        onkeydown="if(event.key === 'Enter') { 
          event.preventDefault();
          const query = $('#search').val().trim();
          if (query) {
            searchVideos();
          } else {
            alert('Vui lòng nhập tên bài hát');
          }
        }">
    </div>
  </div>
  <div class="relative">
    <div class="overflow-x-scroll whitespace-nowrap scrollbar-none px-4" data-testid="filter-chips-container">
      <button class="box-border tap-highlight-transparent bg-transparent border-0 text-inherit cursor-pointer leading-1 tracking-inherit p-0 rounded-md inline-flex align-middle max-w-full mb-2 mr-2 overflow-clip relative flex-shrink-0 marginal font-normal" role="checkbox" aria-checked="false" data-encore-id="chip"><span class="box-border tap-highlight-transparent rounded-md text-white transition-all duration-200 inline-flex min-w-0 min-h-8 items-center py-1 px-3 bg-black/12 font-bold">Tất cả</span></button>
      <button class="box-border tap-highlight-transparent bg-transparent border-0 text-inherit cursor-pointer leading-1 tracking-inherit p-0 rounded-md inline-flex align-middle max-w-full mb-2 mr-2 overflow-clip relative flex-shrink-0 marginal font-normal" role="checkbox" aria-checked="false" data-encore-id="chip"><span class="box-border tap-highlight-transparent rounded-md text-white transition-all duration-200 inline-flex min-w-0 min-h-8 items-center py-1 px-3 bg-black/12 font-bold">Karaoke</span></button>
    </div>
  </div>
</header>
<script>
  $(document).ready(function() {
    const $search = $('#search');
    const $clearSearch = $('#clearSearch');

    $search.on('input', function() {
      $clearSearch.toggle($(this).val().length > 0);
    });

    $clearSearch.on('click', function() {
      $search.val('').trigger('input');
    });

    $search.on('focus', function() {
      if ($(this).val() === '') $(this).val('KARAOKE ');
    });
  });

  const supabaseClient = supabase.createClient('https://wndajplczagmlxbvkmtk.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduZGFqcGxjemFnbWx4YnZrbXRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwMTUzNDcsImV4cCI6MjA0MzU5MTM0N30.1ffeOEC-jOQtar3tgD8OPBUeyK79itCPYmBe3_k08MA');

  function searchVideos() {
      const query = $('#search').val();
      const apiKey = 'AIzaSyDXo9tP0rycwrE4tpXokP1AggTRP7Zt2B4';
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=24&q=${query}&type=video&key=${apiKey}`;
  
      $.getJSON(url, function(data) {
          $('#videoList').empty();
          if (!data.items.length) {
              return alert('Không tìm thấy video nào.');
          }
  
          const videoIds = data.items.map(item => item.id.videoId).join(',');
          const videoDetailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id=${videoIds}&key=${apiKey}`;
  
          $.getJSON(videoDetailsUrl, function(videoDetailsData) {
              data.items.forEach((item, index) => {
                  const { videoId } = item.id;
                  const title = item.snippet.title;
                  const channelTitle = item.snippet.channelTitle;
                  const thumbnailUrl = item.snippet.thumbnails.maxres?.url || item.snippet.thumbnails.high?.url || item.snippet.thumbnails.default.url;
                  const channelThumbnailUrl = item.snippet.thumbnails.default.url;
                  const publishedAt = item.snippet.publishedAt;
                  const viewCount = videoDetailsData.items[index].statistics.viewCount;
                  const duration = formatDuration(videoDetailsData.items[index].contentDetails.duration);
  
                  const videoItem = $(`
                      <div class="cursor-pointer flex w-full flex-col my-3" onclick="handleSongSelection('${videoId}', '${title}')">
                          <div class="relative">
                              <img src="${thumbnailUrl}" class="w-full h-60 object-cover" />
                              <div class="absolute bottom-0 right-0 m-2">
                                  <div class="badge">${duration}</div>
                              </div>
                          </div>
                          <div class="flex items-center" style="margin: 8px 0 0 16px;">
                              <img src="${channelThumbnailUrl}" class="rounded-full w__73X object-cover" />
                              <div class="ml-3 text-left">
                                  <p class="text-white font-bold text-xl line-clamp-2" style="color:#0f0f0f">${title}</p>
                                  <p class="text-gray-400 text-sm" style="color:#606060">${channelTitle} • ${formatViews(viewCount)} • ${formatDate(publishedAt)}</p>
                              </div>
                          </div>
                      </div>
                  `);
                  $('#videoList').append(videoItem);
              });
          });
      });
  }

  function handleSongSelection(videoId, title) {
    const name = prompt("Nhập tên của bạn:");
    if (name) {
      saveSong(videoId, title, name).then(() => {
        window.location.href = '/songs';
      }).catch(() => {
        alert("Đã xảy ra lỗi khi lưu thông tin. Vui lòng thử lại.");
      });
    }
  }

  function saveSong(videoId, songName, name) {
    return supabaseClient.from('karaoke_songs').insert([{ video_id: videoId, song_name: songName, name: name }]);
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    const secondsInMinute = 60;
    const secondsInHour = secondsInMinute * 60;
    const secondsInDay = secondsInHour * 24;
    const secondsInWeek = secondsInDay * 7;
    const secondsInYear = secondsInDay * 365;
  
    if (diffInSeconds < secondsInMinute) {
      return 'Vừa xong';
    } else if (diffInSeconds < secondsInHour) {
      const minutes = Math.floor(diffInSeconds / secondsInMinute);
      return `${minutes} phút trước`;
    } else if (diffInSeconds < secondsInDay) {
      const hours = Math.floor(diffInSeconds / secondsInHour);
      return `${hours} giờ trước`;
    } else if (diffInSeconds < secondsInWeek) {
      const days = Math.floor(diffInSeconds / secondsInDay);
      return `${days} ngày trước`;
    } else if (diffInSeconds < secondsInYear) {
      const weeks = Math.floor(diffInSeconds / secondsInWeek);
      return `${weeks} tuần trước`;
    } else {
      const years = Math.floor(diffInSeconds / secondsInYear);
      return `${years} năm trước`;
    }
  }

  function formatViews(views) {
    return views > 1000000 ? (views / 1000000).toFixed(1) + ' Tr lượt xem' : views > 1000 ? (views / 1000).toFixed(1) + ' N lượt xem' : views + ' lượt xem';
  }

  function formatDuration(duration) {
    const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
    const hours = match[1] ? match[1].slice(0, -1) : '0';
    const minutes = match[2] ? match[2].slice(0, -1) : '0';
    const seconds = match[3] ? match[3].slice(0, -1) : '0';
  
    if (hours === '0') {
      return `${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}`;
    } else {
      return `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}`;
    }
  }
</script>
