<ytm-mobile-topbar-renderer id="header-bar" class="sticky-player">
  <header class="mobile-topbar-header cbox" data-mode="searching" aria-modal="true" role="dialog">
    <button class="mobile-topbar-back-arrow" aria-label="Đóng tìm kiếm">
      <c3-icon>
        <span class="yt-icon-shape yt-spec-icon-shape">
          <div style="width: 100%; height: 100%; display: block; fill: currentcolor;">
            <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24" focusable="false" aria-hidden="true" style="pointer-events: none; display: inherit; width: 100%; height: 100%;">
              <path d="M15.957 2.793a1 1 0 0 1 0 1.414L8.164 12l7.793 7.793a1 1 0 1 1-1.414 1.414L5.336 12l9.207-9.207a1 1 0 0 1 1.414 0z"></path>
            </svg>
          </div>
        </span>
      </c3-icon>
    </button>
    <yt-searchbox role="search" client-ve-type="10349" class="YtSearchboxComponentHost YtSearchboxComponentMweb">
      <div class="YtSearchboxComponentInputBox" style="border-radius:32px;padding: 0 44px 0 12px;">
      <form action="/results" class="YtSearchboxComponentSearchForm" onsubmit="event.preventDefault(); searchVideos();">
        <input name="search_query" type="text" autocomplete="off" autocorrect="off" class="YtSearchboxComponentInput yt-searchbox-input title font-saomaiHeading uppercase font-bold" 
          placeholder="Tìm kiếm" id="search" 
          value="" 
          onkeydown="if(event.key === 'Enter') { 
            event.preventDefault();
            const query = document.getElementById('search').value.trim();
            if (query) {
              searchVideos();
            } else {
              alert('Vui lòng nhập tên bài hát');
            }
          }">
      </form>
      </div>
      <div class="YtSearchboxComponentVoiceSearchWrapper">
        <ytm-button-renderer class="icon-microphone_on">
          <button class="yt-spec-button-shape-next yt-spec-button-shape-next--text yt-spec-button-shape-next--mono yt-spec-button-shape-next--size-m yt-spec-button-shape-next--icon-only-default yt-spec-button-shape-next--enable-backdrop-filter-experiment" aria-label="Tìm kiếm bằng giọng nói" title="" style="">
            <div class="yt-spec-button-shape-next__icon" aria-hidden="true">
              <c3-icon>
                <span class="yt-icon-shape yt-spec-icon-shape">
                  <div style="width: 100%; height: 100%; display: block; fill: currentcolor;">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" focusable="false" aria-hidden="true" style="pointer-events: none; display: inherit; width: 100%; height: 100%;">
                      <g fill="none" fill-rule="evenodd"><path d="M0 0h24v24H0z"></path><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.5 7.5h4-4zm-11 0h2-2zm4 9h-4 4zm11 0h-2 2z"></path><path stroke="currentColor" stroke-linecap="round" stroke-width="1.5" d="M14.5 19.5a3 3 0 110-6 3 3 0 010 6zm-5-9a3 3 0 110-6 3 3 0 010 6z"></path></g>
                    </svg>
                  </div>
                </span>
              </c3-icon>
            </div>
          </button>
        </ytm-button-renderer>
      </div>
    </yt-searchbox>
  </header>
</ytm-mobile-topbar-renderer>
<script>
    $(document).ready(function() {
        $('#search').on('input', function() {
            $('.clear-button').remove();
            if ($(this).val().trim() !== '') {
                const clearButton = `
                    <button class="box-border tap-highlight-transparent bg-transparent border-0 rounded-full cursor-pointer absolute text-center no-underline text-normal touch-manipulation transition-duration-33 transition-all user-select-none vertical-align-middle  color-subdued min-inline-size-0 inline-flex items-center justify-center right-3 color-black top-1-2 -translate-y-1-2 overflow-wrap-anywhere clear-button" style="-webkit-transform: translateY(-50%);transform: translateY(-50%);"
                            data-testid="search-input-clear-button" 
                            aria-label="Clear search field" 
                            data-encore-id="buttonTertiary">
                        <span aria-hidden="true" class="flex">
                            <svg data-encore-id="icon" role="img" aria-hidden="true" viewBox="0 0 16 16" class="w-5 h-5 fill-current">
                                <path d="M2.47 2.47a.75.75 0 0 1 1.06 0L8 6.94l4.47-4.47a.75.75 0 1 1 1.06 1.06L9.06 8l4.47 4.47a.75.75 0 1 1-1.06 1.06L8 9.06l-4.47 4.47a.75.75 0 0 1-1.06-1.06L6.94 8 2.47 3.53a.75.75 0 0 1 0-1.06Z"></path>
                            </svg>
                        </span>
                    </button>
                `;
                $(this).after(clearButton);
            }
        });

        $(document).on('click', '.clear-button', function() {
            $('#search').val('');
            $(this).remove();
        });
    });
</script>
<script>
  $(document).ready(function() {
    const $search = $('#search');
    const $clearSearch = $('#clearSearch');

    $search.on('input', function() {
      $clearSearch.toggle($(this).val().length > 0);
    });

    $clearSearch.on('click', function() {
      $search.val('').trigger('input');
    });
  });

  const supabaseClient = supabase.createClient('https://wndajplczagmlxbvkmtk.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduZGFqcGxjemFnbWx4YnZrbXRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwMTUzNDcsImV4cCI6MjA0MzU5MTM0N30.1ffeOEC-jOQtar3tgD8OPBUeyK79itCPYmBe3_k08MA');
  
  let currentTab = 'TẤT CẢ';
  
  $(document).on('click', '.chip-container', function() {
      const parentChip = $(this).closest('ytm-chip-cloud-chip-renderer');
      if (parentChip.attr('chip-style') === 'STYLE_HOME_FILTER') {
          $('ytm-chip-cloud-chip-renderer').removeClass('selected all-chip-renderer');
          parentChip.addClass('selected all-chip-renderer');
          $('ytm-chip-cloud-chip-renderer').attr('aria-selected', 'false');
          parentChip.attr('aria-selected', 'true');
          const selectedTab = $(this).attr('aria-label');
          currentTab = selectedTab;
          searchVideos();
      }
  });

function searchVideos() {
    const baseQuery = $('#search').val().trim();
    if (!baseQuery) {
        return;
    }
    let query = baseQuery;
    if (currentTab !== 'TẤT CẢ') {
        query = `${currentTab.toLowerCase()} ${baseQuery}`;
    }
    
    const apiKey = 'AIzaSyAaQnJKKHqLZIQKCAFiwStspPcAKskUxmE';
    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=24&q=${query}&type=video&key=${apiKey}`;

    $.getJSON(url, function (data) {
        $('#videoList').empty();
        const wrapper = $('<div id="list" class="w-full h-full"></div>');
        $('#videoList').append(wrapper);

        if (!data.items.length) {
            return alert('Không tìm thấy video nào.');
        }

        const videoIds = data.items.map(item => item.id.videoId).join(',');
        const channelIds = [...new Set(data.items.map(item => item.snippet.channelId))].join(',');
        const videoDetailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id=${videoIds}&key=${apiKey}`;
        const channelDetailsUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${channelIds}&key=${apiKey}`;

        Promise.all([
            $.getJSON(videoDetailsUrl),
            $.getJSON(channelDetailsUrl)
        ]).then(([videoDetailsData, channelData]) => {
            const channelThumbnails = {};

            channelData.items.forEach(channel => {
                channelThumbnails[channel.id] = channel.snippet.thumbnails.default.url;
            });

            data.items.forEach((item, index) => {
                const { videoId } = item.id;
                const title = item.snippet.title;
                const channelTitle = item.snippet.channelTitle;
                const thumbnailUrl = item.snippet.thumbnails.maxres?.url || item.snippet.thumbnails.high?.url || item.snippet.thumbnails.default.url;
                const channelId = item.snippet.channelId;
                const publishedAt = item.snippet.publishedAt;
                const viewCount = videoDetailsData.items[index].statistics.viewCount;
                const duration = formatDuration(videoDetailsData.items[index].contentDetails.duration);
                const channelThumbnailUrl = channelThumbnails[channelId];

                const mbClass = index === data.items.length - 1 ? '' : ' mb-6';
                const videoItem = $(`
                    <div class="cursor-pointer flex w-full flex-col${mbClass}" onclick="handleSongSelection('${videoId}', '${title}')">
                        <div class="relative video-thumbnail-container-large center block m-0 p-0">
                            <div class="cover video-thumbnail-img video-thumbnail-bg"></div>
                            <img src="${thumbnailUrl}" class="w-full h-full cover object-cover" />
                            <div class="absolute bottom-0 right-0 m-2">
                                <div class="badge">${duration}</div>
                            </div>
                        </div>
                        <div class="details">
                            <div class="media-channel">
                                <icon class="channel-thumbnail-icon YtProfileIconHost" aria-hidden="false">
                                    <img alt="Truy cập kênh" class="YtProfileIconImage" src="${channelThumbnailUrl}">
                                </icon>
                            </div>
                            <div class="media-item-info cbox">
                                <div class="media-item-metadata">
                                    <h3 class="mb-1">
                                        <span class="text-black font-bold line-clamp-2 leading-6 text-lg">${title}</span>
                                    </h3>
                                    <span class="text-gray-400 text-base">${channelTitle} • ${formatViews(viewCount)} • ${formatDate(publishedAt)}</span>
                                </div>
                                <menu-renderer class="media-item-menu">
                                    <menu>
                                        <button class="icon-button text-black" aria-label="Menu" aria-haspopup="true">
                                            <c3-icon>
                                                <span class="yt-icon-shape yt-spec-icon-shape">
                                                    <div style="width: 100%; height: 100%; display: block; fill: currentcolor;">
                                                        <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24">
                                                            <path d="M10.5 4.5a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0zm0 15a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0zm0-7.5a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0z"></path>
                                                        </svg>
                                                    </div>
                                                </span>
                                            </c3-icon>
                                        </button>
                                    </menu>
                                </menu-renderer>
                            </div>
                        </div>
                    </div>
                `);
                $('#list').append(videoItem);
            });
        }).catch(error => {
            console.error("Error fetching video/channel details: ", error);
            alert('Có lỗi xảy ra trong quá trình tải dữ liệu. Vui lòng thử lại sau.');
        });
    });
}
  
  function handleSongSelection(videoId, title) {
    const name = prompt("Nhập tên của bạn:");
    if (name) {
      saveSong(videoId, title, name).then(() => {
        window.location.href = '/songs';
      }).catch(() => {
        alert("Đã xảy ra lỗi khi lưu thông tin. Vui lòng thử lại.");
      });
    }
  }

  function saveSong(videoId, songName, name) {
    return supabaseClient.from('karaoke_songs').insert([{ video_id: videoId, song_name: songName, name: name }]);
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    const secondsInMinute = 60;
    const secondsInHour = secondsInMinute * 60;
    const secondsInDay = secondsInHour * 24;
    const secondsInWeek = secondsInDay * 7;
    const secondsInYear = secondsInDay * 365;
  
    if (diffInSeconds < secondsInMinute) {
      return 'Vừa xong';
    } else if (diffInSeconds < secondsInHour) {
      const minutes = Math.floor(diffInSeconds / secondsInMinute);
      return `${minutes} phút trước`;
    } else if (diffInSeconds < secondsInDay) {
      const hours = Math.floor(diffInSeconds / secondsInHour);
      return `${hours} giờ trước`;
    } else if (diffInSeconds < secondsInWeek) {
      const days = Math.floor(diffInSeconds / secondsInDay);
      return `${days} ngày trước`;
    } else if (diffInSeconds < secondsInYear) {
      const weeks = Math.floor(diffInSeconds / secondsInWeek);
      return `${weeks} tuần trước`;
    } else {
      const years = Math.floor(diffInSeconds / secondsInYear);
      return `${years} năm trước`;
    }
  }

  function formatViews(views) {
    return views > 1000000 ? (views / 1000000).toFixed(1) + ' Tr lượt xem' : views > 1000 ? (views / 1000).toFixed(1) + ' N lượt xem' : views + ' lượt xem';
  }

  function formatDuration(duration) {
    const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
  
    if (!match) {
      return '00:00';
    }
  
    const hours = match[1] ? match[1].slice(0, -1) : '0';
    const minutes = match[2] ? match[2].slice(0, -1) : '0';
    const seconds = match[3] ? match[3].slice(0, -1) : '0';
  
    if (hours === '0') {
      return `${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}`;
    } else {
      return `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}`;
    }
  }
  
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    return parts.length === 2 ? parts.pop().split(';').shift() : null;
  }
  const karaokeSaoMaiCookie = getCookie('karaokeSaoMai');
  if (karaokeSaoMaiCookie) {
    $('body').css('overflow', 'hidden');
    $('#content').load('infor.html', function(response, status, xhr) {
      if (status == "error") {
        console.log("Error loading infor.html: " + xhr.status + " " + xhr.statusText);
      }
    });
  }
</script>
