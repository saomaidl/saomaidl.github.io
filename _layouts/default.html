<!DOCTYPE html>
<html lang="{{ site.lang | default: 'vi' }}">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" type="image/png" href="{{ site.baseurl }}/assets/favicon/favicon-48x48.png" sizes="48x48" />
  <link rel="icon" type="image/svg+xml" href="{{ site.baseurl }}/assets/favicon/favicon.svg" />
  <link rel="shortcut icon" href="{{ site.baseurl }}/assets/favicon/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="{{ site.baseurl }}/assets/favicon/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Sao Mai" />
  <link rel="manifest" href="{{ site.baseurl }}/assets/favicon/site.webmanifest" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="black" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <link rel="alternate" href="{{ page.url | prepend: site.baseurl }}" hreflang="{{ page.lang | default: 'vi' }}">
  <link rel="canonical" href="{{ page.url | prepend: site.baseurl }}">
  <title>{{ page.title | default: site.title }}</title>
  <meta name="description" content="{{ page.description | default: site.description }}">
  <meta property="og:locale" content="{{ site.locale | default: 'vi_VN' }}">
  <meta property="og:type" content="website">
  <meta property="og:title" content="{{ page.title | default: site.title }}">
  <meta property="og:description" content="{{ page.description | default: site.description }}">
  <meta property="og:url" content="{{ page.url | prepend: site.baseurl }}">
  <meta property="og:site_name" content="{{ site.name }}">
  <meta property="article:modified_time" content="{{ page.date | date_to_xmlschema }}">  
  <meta name="twitter:card" content="summary_large_image">
  <link rel="stylesheet" href="/assets/css/app.css">
  <link rel="stylesheet" href="/assets/css/font.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input {
      text-transform: uppercase; 
    }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            pink: "#EF7C8E",
            'gray-text': '#181818',
            'tap-highlight': 'transparent',
            'black/12': 'hsla(0,0%,100%,.1)',
            'text-subdued': '#656565',
            'black': '#000',
            'icon': '#0f0f0f',
          },
          lineHeight: {
            normal: 'normal',
            1: '1',
          },
          minHeight: {
            '48px': '48px',
            8: '32px',
          },
          backgroundColor: {
            'gray-top': '#181818',
          },
          padding: {
            '12px': '12px',
            '12-16': '12px 16px',
            '0-16': '0 16px',
          },
          fontSize: {
            marginal: '0.6875rem',
          },
          fontFamily: {
            saomaiHeading: ['saomaiHeading', 'sans-serif'],
          },
          translate: {
            '1-2': '50%',
          },
          spacing: {
            '70px': '70px',
          },
          letterSpacing: {
            inherit: 'inherit',
          },
          overflowWrap: {
            clip: 'break-word',
          },
          verticalAlign: {
            middle: 'middle',
          },
          minInlineSize: {
            '0': '0px',
          },
          transitionDuration: {
            '33': '33ms',
          },
        },
      },
      plugins: [
        function ({ addComponents }) {
          addComponents({
            'h1, h2, h3, h4, h5, h6': {
              '@apply font-saomaiHeading font-bold': {},
            },
          });
        },
        function ({ addBase }) {
          addBase({
            'audio, canvas, embed, iframe, img, object, svg, video': {
              display: 'inline-block',
            },
          });
        },
        function ({ addUtilities }) {
          addUtilities({
            '.encore-text': {
              '-webkit-box-sizing': 'border-box',
              'box-sizing': 'border-box',
              '-webkit-tap-highlight-color': 'transparent',
              'color': 'inherit',
              'margin-block': '0',
            },
            'body': {
              'font-family': 'saomai, sans-serif',
              'background-color': '#fff',
              'margin': '0',
              '-webkit-tap-highlight-color': 'hsla(0, 0%, 100%, .1)',
              'display': 'flex',
            },
            '.scrollbar-none': {
              '&::-webkit-scrollbar': {
                display: 'none',
              },
              '-ms-overflow-style': 'none',
              'scrollbar-width': 'none',
            },
            '.transition-duration-33': {
              'transition-duration': '33ms',
            },
            '.top-1-2': {
              top: '50%',
            },
            '.right-3': {
              right: '12px',
            },
            '.line-clamp-2': {
              display: '-webkit-box',
              '-webkit-box-orient': 'vertical',
              '-webkit-line-clamp': '2',
              overflow: 'hidden',
              'min-height': '1.5rem',
              'max-height': '3rem',
              'white-space': 'pre-wrap',
            },
            '.overflow-wrap-anywhere': {
              'overflow-wrap': 'anywhere',
            },
            '.vertical-align-middle': {
              'vertical-align': 'middle',
            },
          }, ['responsive', 'hover']);
        },
      ],
    };
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
      $(document).ready(function() {
          $('#search').on('input', function() {
              $('.clear-button').remove();
              if ($(this).val().trim() !== '') {
                  const clearButton = `
                      <button class="box-border tap-highlight-transparent bg-transparent border-0 rounded-full cursor-pointer absolute text-center no-underline text-normal touch-manipulation transition-duration-33 transition-all user-select-none vertical-align-middle  color-subdued min-inline-size-0 inline-flex items-center justify-center right-3 color-black top-1-2 -translate-y-1-2 overflow-wrap-anywhere clear-button" style="-webkit-transform: translateY(-50%);transform: translateY(-50%);"
                              data-testid="search-input-clear-button" 
                              aria-label="Clear search field" 
                              data-encore-id="buttonTertiary">
                          <span aria-hidden="true" class="flex">
                              <svg data-encore-id="icon" role="img" aria-hidden="true" viewBox="0 0 16 16" class="w-5 h-5 fill-current">
                                  <path d="M2.47 2.47a.75.75 0 0 1 1.06 0L8 6.94l4.47-4.47a.75.75 0 1 1 1.06 1.06L9.06 8l4.47 4.47a.75.75 0 1 1-1.06 1.06L8 9.06l-4.47 4.47a.75.75 0 0 1-1.06-1.06L6.94 8 2.47 3.53a.75.75 0 0 1 0-1.06Z"></path>
                              </svg>
                          </span>
                      </button>
                  `;
                  $(this).after(clearButton);
              }
          });
  
          $(document).on('click', '.clear-button', function() {
              $('#search').val('');
              $(this).remove();
          });
      });
  </script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
    import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js';
    import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
  
    const firebaseConfig = {
      apiKey: "AIzaSyBBPKJcXjkZ0wUbXNremQuf_R1Z6baYcU0",
      authDomain: "karaoke-3aa8f.firebaseapp.com",
      databaseURL: "https://karaoke-3aa8f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "karaoke-3aa8f",
      storageBucket: "karaoke-3aa8f.appspot.com",
      messagingSenderId: "652741363415",
      appId: "1:652741363415:web:e33bb49a0be7eed7e09292"
    };
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
  
    async function handleSongSelection(videoId, title) {
      const user = auth.currentUser;
      const userDoc = await getDoc(doc(db, 'users', user.uid));
  
      if (userDoc.exists() && userDoc.data().songSelected) {
        loadSelectedFile();
        return;
      }
  
      try {
        await setDoc(doc(db, 'users', user.uid), {
          songSelected: true,
          videoId: videoId,
          songName: title,
        }, { merge: true });
  
        loadSelectedFile();
      } catch (error) {
        console.error("Error saving song: ", error);
      }
    }
    
    window.handleSongSelection = handleSongSelection;
    
    $(document).ready(function() {
      async function loadSelectedFile() {
        const user = auth.currentUser;
        const userDoc = await getDoc(doc(db, 'users', user.uid));
  
        if (userDoc.exists() && userDoc.data().songSelected) { 
          $('#content').load('/assets/html/selected.html', function(response, status, xhr) {
            if (status === "error") {
              console.error("Không thể tải tệp selected.html:", xhr.status, xhr.statusText);
            } else {
              $('body').css('overflow', 'hidden');
            }
          });
        }
      }
  
      async function checkUser() {
        const user = auth.currentUser;
        if (!user) {
          await signInAnonymously(auth);
          return checkUser();
        } else {
          const userDoc = await getDoc(doc(db, 'users', user.uid));
          if (!userDoc.exists() || !userDoc.data().fullName) {
            $('#content').load('/assets/html/infor.html', function(response, status, xhr) {
              if (status == "success") {
                $('body').css('overflow', 'hidden');
              }
            });
          } else {
            loadSelectedFile();
          }
        }
      }
  
      $(document).on('submit', '#edit-full-name-form', async function(event) {
        event.preventDefault();
        var title = $('#title').val().trim().toUpperCase();
        var fullName = $('#fullName').val().trim().toUpperCase();
        var location = $('#location').val().trim().toUpperCase();
        if (!title || !fullName) {
          return;
        }
        const user = auth.currentUser;
        await setDoc(doc(db, 'users', user.uid), {
          title: title,
          fullName: fullName,
          location: location,
          songSelected: false
        });
        $('#content').empty();
        $('body').removeAttr('style');
      });
  
      checkUser();
      $('#search').on('keydown', function(event) {
        if (event.key === 'Enter') {
          searchVideos();
        }
      });
    });
  
    $(document).ready(function() {
      const $search = $('#search');
      const $clearSearch = $('#clearSearch');
      $search.on('input', function() {
        $clearSearch.toggle($(this).val().length > 0);
      });
      $clearSearch.on('click', function() {
        $search.val('').trigger('input');
      });
    });
  
    let currentTab = 'TẤT CẢ';
    $(document).on('click', '.chip-container', function() {
      const parentChip = $(this).closest('ytm-chip-cloud-chip-renderer');
      if (parentChip.attr('chip-style') === 'STYLE_HOME_FILTER') {
        $('ytm-chip-cloud-chip-renderer').removeClass('selected all-chip-renderer');
        parentChip.addClass('selected all-chip-renderer');
        $('ytm-chip-cloud-chip-renderer').attr('aria-selected', 'false');
        parentChip.attr('aria-selected', 'true');
        const selectedTab = $(this).attr('aria-label');
        currentTab = selectedTab;
        searchVideos();
      }
    });
  
    function searchVideos() {
      const baseQuery = $('#search').val().trim();
      if (!baseQuery) {
        return;
      }
      let query = baseQuery;
      if (currentTab !== 'TẤT CẢ') {
        query = `${currentTab.toLowerCase()} ${baseQuery}`;
      }
  
      const apiKey = 'AIzaSyAaQnJKKHqLZIQKCAFiwStspPcAKskUxmE';
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=24&q=${query}&type=video&key=${apiKey}`;
  
      $.getJSON(url, function (data) {
        $('#videoList').empty();
        const wrapper = $('<div id="list" class="w-full h-full"></div>');
        $('#videoList').append(wrapper);
  
        if (!data.items.length) {
          return alert('Không tìm thấy video nào.');
        }
  
        const videoIds = data.items.map(item => item.id.videoId).join(',');
        const channelIds = [...new Set(data.items.map(item => item.snippet.channelId))].join(',');
        const videoDetailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,statistics&id=${videoIds}&key=${apiKey}`;
        const channelDetailsUrl = `https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${channelIds}&key=${apiKey}`;
  
        Promise.all([
          $.getJSON(videoDetailsUrl),
          $.getJSON(channelDetailsUrl)
        ]).then(([videoDetailsData, channelData]) => {
          const channelThumbnails = {};
  
          channelData.items.forEach(channel => {
            channelThumbnails[channel.id] = channel.snippet.thumbnails.default.url;
          });
  
          data.items.forEach((item, index) => {
            const { videoId } = item.id;
            const title = item.snippet.title;
            const channelTitle = item.snippet.channelTitle;
            const thumbnailUrl = item.snippet.thumbnails.maxres?.url || item.snippet.thumbnails.high?.url || item.snippet.thumbnails.default.url;
            const channelId = item.snippet.channelId;
            const publishedAt = item.snippet.publishedAt;
            const viewCount = videoDetailsData.items[index].statistics.viewCount;
            const duration = formatDuration(videoDetailsData.items[index].contentDetails.duration);
            const channelThumbnailUrl = channelThumbnails[channelId];
  
            const mbClass = index === data.items.length - 1 ? '' : ' mb-6';
            const videoItem = $(`
                <div class="cursor-pointer flex w-full flex-col${mbClass}" onclick="handleSongSelection('${videoId}', '${title}')">
                    <div class="relative video-thumbnail-container-large center block m-0 p-0">
                        <div class="cover video-thumbnail-img video-thumbnail-bg"></div>
                        <img src="${thumbnailUrl}" class="w-full h-full cover object-cover" />
                        <div class="absolute bottom-0 right-0 m-2">
                            <div class="badge">${duration}</div>
                        </div>
                    </div>
                    <div class="details">
                        <div class="media-channel">
                            <icon class="channel-thumbnail-icon YtProfileIconHost" aria-hidden="false">
                                <img alt="Truy cập kênh" class="YtProfileIconImage" src="${channelThumbnailUrl}">
                            </icon>
                        </div>
                        <div class="media-item-info cbox">
                            <div class="media-item-metadata">
                                <h3 class="mb-1">
                                    <span class="text-black font-bold line-clamp-2 leading-6 text-lg">${title}</span>
                                </h3>
                                <span class="text-gray-400 text-sm">${channelTitle} • ${formatViews(viewCount)} • ${formatDate(publishedAt)}</span>
                            </div>
                            <menu-renderer class="media-item-menu">
                                <menu>
                                    <button class="icon-button text-black" aria-label="Menu" aria-haspopup="true">
                                        <c3-icon>
                                            <span class="yt-icon-shape yt-spec-icon-shape">
                                                <div style="width: 100%; height: 100%; display: block; fill: currentcolor;">
                                                    <svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24">
                                                        <path d="M10.5 4.5a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0zm0 15a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0zm0-7.5a1.5 1.5 0 1 0 3 0 1.5 1.5 0 0 0-3 0z"></path>
                                                    </svg>
                                                </div>
                                            </span>
                                        </c3-icon>
                                    </button>
                                </menu>
                            </menu-renderer>
                        </div>
                    </div>
                </div>
            `);
            $('#list').append(videoItem);
          });
        }).catch(error => {
          console.error("Error fetching video/channel details: ", error);
        });
      });
    }
  
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      const secondsInMinute = 60;
      const secondsInHour = secondsInMinute * 60;
      const secondsInDay = secondsInHour * 24;
      const secondsInWeek = secondsInDay * 7;
      const secondsInYear = secondsInDay * 365;
  
      if (diffInSeconds < secondsInMinute) {
        return 'Vừa xong';
      } else if (diffInSeconds < secondsInHour) {
        const minutes = Math.floor(diffInSeconds / secondsInMinute);
        return `${minutes} phút trước`;
      } else if (diffInSeconds < secondsInDay) {
        const hours = Math.floor(diffInSeconds / secondsInHour);
        return `${hours} giờ trước`;
      } else if (diffInSeconds < secondsInWeek) {
        const days = Math.floor(diffInSeconds / secondsInDay);
        return `${days} ngày trước`;
      } else if (diffInSeconds < secondsInYear) {
        const weeks = Math.floor(diffInSeconds / secondsInWeek);
        return `${weeks} tuần trước`;
      } else {
        const years = Math.floor(diffInSeconds / secondsInYear);
        return `${years} năm trước`;
      }
    }
  
    function formatViews(views) {
      return views > 1000000 ? (views / 1000000).toFixed(1) + ' Tr lượt xem' : views > 1000 ? (views / 1000).toFixed(1) + ' N lượt xem' : views + ' lượt xem';
    }
  
    function formatDuration(duration) {
      const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
      if (!match) {
        return '00:00';
      }
  
      const hours = match[1] ? match[1].slice(0, -1) : '0';
      const minutes = match[2] ? match[2].slice(0, -1) : '0';
      const seconds = match[3] ? match[3].slice(0, -1) : '0';
  
      return hours === '0' ? `${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}` : `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}:${seconds.padStart(2, '0')}`;
    }
  </script>
  
</head>

<body>
  <div id="__next" class="z-0 h-full w-full">
    <div>
      <div class="h-full">
        <div data-main-scrollable-node="true" class="block h-full overflow-x-hidden overflow-y-auto relative w-full">
          <div class="flex flex-col min-h-screen">
            <div class="flex flex-col flex-1 overflow-y-auto pb-0" style="margin-bottom: 70px;">
              <div class="flex flex-col min-h-full relative w-full flex-1 p-0">
                {{ content }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="content"></div>
</body>

</html>
