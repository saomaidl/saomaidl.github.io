<div class="w_Qz6x mobile-modal">
  <div data-focus-guard="true" tabindex="0" style="width: 1px; height: 0px; padding: 0px; overflow: hidden; position: fixed; top: 1px; left: 1px;"></div>
  <div data-focus-lock-disabled="false" class="w_hPDp">
    <div class="w_32Rp">
      <div class="w_m4hJ" role="dialog">
        <div class="w_iMLF">
          <button aria-label="Close dialog" class="w_Rfk5 customClose" type="button" onclick="window.location.href='https://saomaidl.github.io/songs';">
            <svg fill="currentColor" height="1em" viewBox="0 0 16 16" width="1em" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="presentation" style="font-size: 1.5rem; vertical-align: -0.25em;">
              <path fill-rule="evenodd" d="M3.05 3.05a.5.5 0 0 1 .707 0L8 7.293l4.243-4.243a.5.5 0 0 1 .707.707L8.707 8l4.243 4.243a.5.5 0 0 1-.707.707L8 8.707 3.757 12.95a.5.5 0 0 1-.707-.707L7.293 8 3.05 3.757a.5.5 0 0 1 0-.707Z"></path>
            </svg>
          </button>
          <h2 class="w_d_KY">Chọn bài thành công</h2>
        </div>
        <div class="w_iu_y">
          <div class="w_tGqM">
            <div style="margin-top: 0px;">
              <div class="splashSection static w-100 mt0" style="background-color: rgb(4, 30, 66);padding-bottom: 0px;">
                <div class="tc mt1" style="padding: 0px 20px 48px;">
                  <h3 class="mt0 mb0 f3 normal white mb1" style="font-family:'saomai';">Cảm ơn quý khách đã chọn</h3>
                  <div class="mt2">
                    <h3 class="text-[32px] inline-flex gap-[2px] items-center justify-center" style="letter-spacing:-.1rem;">
                      <div class="white">Saomai</div>
                      <a link-identifier="saomaiLogoMobile" class="gold h-[32px] w-[32px] flex" aria-hidden="false" aria-label="Sao Mai Homepage" data-automation-id="header-link-saomaiLogo" href="/"><i class="ld ld-Spark" style="font-size:2rem;vertical-align:-0.325em;width:2rem;height:2rem;box-sizing:content-box" aria-hidden="true"></i></a>
                      <div class="white font-normal" style="font-family: 'saomai';">Karaoke</div>
                    </h3>
                  </div>
                  <div class="mt4 text-xl mb3">
                    <div class="white" style="color: rgb(128, 184, 238);">Chúng tôi sẽ gọi quý khách</div>
                    <div class="white ml1" id="song_status">sau 5 bài nữa</div>
                  </div>
                  <button class="w_eEg0 w_OoNT w_4QgR mt5 w-100" type="button" data-testid="playlist" onclick="window.location.href='https://saomaidl.github.io/songs';">Xem danh sách phát</button>
                </div>
              </div>
            </div>
            <div class="overlayDiv" aria-hidden="true" data-testid="splash-overlay"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="w_NOPS w_C76E"></div>
  </div>
  <div data-focus-guard="true" tabindex="0" style="width: 1px; height: 0px; padding: 0px; overflow: hidden; position: fixed; top: 1px; left: 1px;"></div>
</div>
<script>
const supabaseUrl = 'https://wndajplczagmlxbvkmtk.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InduZGFqcGxjemFnbWx4YnZrbXRrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjgwMTUzNDcsImV4cCI6MjA0MzU5MTM0N30.1ffeOEC-jOQtar3tgD8OPBUeyK79itCPYmBe3_k08MA';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

// Hàm lấy cookie karaokeSaoMai
function getKaraokeSaoMaiCookie() {
    const cookieString = document.cookie.split('; ').find(row => row.startsWith('karaokeSaoMai='));
    return cookieString ? JSON.parse(cookieString.split('=')[1]) : null;
}

// Hàm lấy danh sách video chưa phát từ Supabase
async function getUnplayedVideoIds() {
    const { data, error } = await supabaseClient
        .from('karaoke_songs')
        .select('*') // lấy tất cả các cột để dễ theo dõi
        .eq('played', false) // chỉ lấy những bài chưa phát
        .order('priority', { ascending: false }) // sắp xếp theo priority, true trước
        .order('id', { ascending: true }); // nếu priority giống nhau thì sắp xếp theo id tăng dần

    if (error) {
        console.error('Có lỗi xảy ra khi lấy video_ids:', error);
        return [];
    }

    return data; // trả về toàn bộ dữ liệu để xử lý theo nhu cầu
}

// Hàm để kiểm tra và hiển thị thứ tự của người dùng theo cookie
function updateSongStatus(songs) {
    const songStatusDiv = document.getElementById('song_status');
    const cookie = getKaraokeSaoMaiCookie();

    if (!cookie) {
        songStatusDiv.textContent = 'Không tìm thấy thông tin từ cookie.';
        return;
    }

    const userSongIndex = songs.findIndex(song => {
        const name = JSON.parse(song.name);
        return name.fullName === cookie.fullName && name.title === cookie.title;
    });

    if (userSongIndex === -1) {
        songStatusDiv.textContent = 'Thông tin của bạn không có trong danh sách chờ.';
    } else {
        const numRemaining = userSongIndex;
        songStatusDiv.textContent = `Còn ${numRemaining} bài nữa trước khi đến lượt bạn.`;
    }
}

// Hàm lấy danh sách video chưa phát và cập nhật nội dung
async function getRealtimeSongPosition() {
    const songs = await getUnplayedVideoIds();
    
    // Cập nhật thứ tự dựa trên thông tin cookie
    updateSongStatus(songs);

    if (songs.length > 0) {
        const song = songs[0];

        // Theo dõi realtime thay đổi của bài hát đầu tiên
        supabaseClient
            .from(`karaoke_songs:id=eq.${song.id}`)
            .on('UPDATE', payload => {
                console.log('Dữ liệu đã cập nhật:', payload.new);
                // Cập nhật lại danh sách và nội dung sau khi có thay đổi
                getRealtimeSongPosition();
            })
            .subscribe();
    }
}

// Gọi hàm để lấy vị trí realtime của bản ghi dựa trên thứ tự sắp xếp
getRealtimeSongPosition();
</script>
